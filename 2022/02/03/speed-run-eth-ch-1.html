<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How I Implemented Speed Run ETH Challenge 1 | Leo Gau</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="How I Implemented Speed Run ETH Challenge 1" />
<meta name="author" content="Leo Gau" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How I Implemented Speed Run ETH Challenge 1" />
<meta property="og:description" content="How I Implemented Speed Run ETH Challenge 1" />
<link rel="canonical" href="https://leogau.dev/2022/02/03/speed-run-eth-ch-1.html" />
<meta property="og:url" content="https://leogau.dev/2022/02/03/speed-run-eth-ch-1.html" />
<meta property="og:site_name" content="Leo Gau" />
<meta property="og:image" content="https://leogau.dev/images/fastpages_posts/actions/actions_logo.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-02-03T00:00:00-06:00" />
<script type="application/ld+json">
{"url":"https://leogau.dev/2022/02/03/speed-run-eth-ch-1.html","@type":"BlogPosting","headline":"How I Implemented Speed Run ETH Challenge 1","dateModified":"2022-02-03T00:00:00-06:00","datePublished":"2022-02-03T00:00:00-06:00","image":"https://leogau.dev/images/fastpages_posts/actions/actions_logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://leogau.dev/2022/02/03/speed-run-eth-ch-1.html"},"author":{"@type":"Person","name":"Leo Gau"},"description":"How I Implemented Speed Run ETH Challenge 1","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://leogau.dev/feed.xml" title="Leo Gau" /><!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-40857106-3"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "UA-40857106-3", { anonymize_ip: true });
</script>


<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Leo Gau</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="https://twitter.com/leogau" target="_blank">About</a><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How I Implemented Speed Run ETH Challenge 1</h1><p class="page-description">How I Implemented Speed Run ETH Challenge 1</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-02-03T00:00:00-06:00" itemprop="datePublished">
        Feb 3, 2022
      </time>‚Ä¢ 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Leo Gau</span></span>
       ‚Ä¢ <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i>
      
        <a class="category-tags-link" href="/categories/#solidity">solidity</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#ethereum">ethereum</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#draft">DRAFT</a></li>
<li class="toc-entry toc-h1"><a href="#how-i-implemented-speed-run-eth-challenge-1">How I Implemented Speed Run ETH Challenge 1</a></li>
<li class="toc-entry toc-h1"><a href="#what-im-building">What I‚Äôm Building</a></li>
<li class="toc-entry toc-h1"><a href="#the-code">The Code</a></li>
<li class="toc-entry toc-h1"><a href="#checkpoint-2-staking">Checkpoint 2: Staking</a></li>
<li class="toc-entry toc-h1"><a href="#checkpoint-3">Checkpoint 3</a></li>
<li class="toc-entry toc-h1"><a href="#checkpoint-4">Checkpoint 4</a></li>
<li class="toc-entry toc-h1"><a href="#so-what-did-we-do">So What Did We Do?</a></li>
</ul><h1 id="draft">
<a class="anchor" href="#draft" aria-hidden="true"><span class="octicon octicon-link"></span></a>DRAFT</h1>

<h1 id="how-i-implemented-speed-run-eth-challenge-1">
<a class="anchor" href="#how-i-implemented-speed-run-eth-challenge-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>How I Implemented Speed Run ETH Challenge 1</h1>

<h1 id="what-im-building">
<a class="anchor" href="#what-im-building" aria-hidden="true"><span class="octicon octicon-link"></span></a>What I‚Äôm Building</h1>

<p>In this post, I‚Äôll show you how I implemented Challenge 1 of Speed Run ETH.</p>

<p>Here‚Äôs the description from the challenge page: https://speedrunethereum.com/challenge/decentralized-staking</p>

<blockquote>
  <p>üè¶ Build a <code class="language-plaintext highlighter-rouge">Staker.sol</code> contract that collects <strong>ETH</strong> from numerous addresses using a payable <code class="language-plaintext highlighter-rouge">stake()</code> function and keeps track of <code class="language-plaintext highlighter-rouge">balances</code>. After some <code class="language-plaintext highlighter-rouge">deadline</code> if it has at least some <code class="language-plaintext highlighter-rouge">threshold</code> of ETH, it sends it to an <code class="language-plaintext highlighter-rouge">ExampleExternalContract</code> and triggers the <code class="language-plaintext highlighter-rouge">complete()</code> action sending the full balance. If not enough <strong>ETH</strong> is collected, allow users to <code class="language-plaintext highlighter-rouge">withdraw()</code>.</p>
</blockquote>

<h1 id="the-code">
<a class="anchor" href="#the-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Code</h1>

<p>Deployed contract address:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// SPDX-License-Identifier: MIT
pragma solidity 0.8.4;

import "hardhat/console.sol";
import "./ExampleExternalContract.sol";

contract Staker {
  // VARIABLES
  /// External contract that will hold staked funds if threshold reached
  ExampleExternalContract public exampleExternalContract;

  /// Balances of user's staked funds
  mapping (address =&gt; uint256) public balances;

  /// Staking threshold
  uint256 public constant threshold = 1 ether;

  /// Staking deadline
  uint256 public deadline = block.timestamp + 72 hours;

  /// Boolean set if threshold is not reached by the deadline
  bool public openForWithdraw;

  // EVENTS
  /// Emit when stake() is called
  event Stake(address sender, uint256 value);

  // MODIFIERS
  /// Modifier that checks whether the required deadline has passed
  modifier deadlinePassed(bool requireDeadlinePassed) {
    uint256 timeRemaining = timeLeft();
    if (requireDeadlinePassed) {
      require(timeRemaining &lt;= 0, "Deadline has not been passed yet");
    } else {
      require(timeRemaining &gt; 0, "Deadline is already passed");
    }
    _;
  }

  /// Modifier that checks whether the external contract is completed
  modifier stakingNotCompleted() {
    bool completed = exampleExternalContract.completed();
    require(!completed, "Staking period has completed");
    _;
  }

  constructor(address exampleExternalContractAddress) public {
      exampleExternalContract = ExampleExternalContract(exampleExternalContractAddress);
  }

  // Collect funds in a payable `stake()` function and track individual `balances` with a mapping:
  //  ( make sure to add a `Stake(address,uint256)` event and emit it for the frontend &lt;List/&gt; display )
  function stake() public payable deadlinePassed(false) stakingNotCompleted {
    // update the sender's balance
    balances[msg.sender] += msg.value;

    // emit Stake event to notify the UI
    emit Stake(msg.sender, msg.value);
  }


  // After some `deadline` allow anyone to call an `execute()` function
  //  It should either call `exampleExternalContract.complete{value: address(this).balance}()` to send all the value
  function execute() public stakingNotCompleted {
    uint256 contractBalance = address(this).balance;
    if (contractBalance &gt;= threshold) {
      // if the `threshold` is met, send the balance to the externalContract
      exampleExternalContract.complete{value: contractBalance}();
    } else {
      // if the `threshold` was not met, allow everyone to call a `withdraw()` function
      openForWithdraw = true;
    }
  }



  // Add a `withdraw(address payable)` function lets users withdraw their balance
  function withdraw(address payable _to) public deadlinePassed(true) stakingNotCompleted {
      // check the amount staked did not reach the threshold by the deadline
      require(openForWithdraw, "Not open for withdraw");

      // get the sender balance
      uint256 userBalance = balances[msg.sender];

      // check if the sender has a balance to withdraw
      require(userBalance &gt; 0, "userBalance is 0");

      // reset the sender's balance
      balances[msg.sender] = 0;

      // transfer sender's balance to the `_to` address
      (bool sent, ) = _to.call{value: userBalance}("");

      // check transfer was successful
      require(sent, "Failed to send to address");
  }

  /// Add a `timeLeft()` view function that returns the time left before the deadline for the frontend
  function timeLeft() public view returns (uint256) {
      if (block.timestamp &gt;= deadline) {
          return 0;
      } else {
          return deadline - block.timestamp;
      }
  }


  // Add the `receive()` special function that receives eth and calls stake()
  receive() external payable {
      stake();
  }
}
</code></pre></div></div>

<h1 id="checkpoint-2-staking">
<a class="anchor" href="#checkpoint-2-staking" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checkpoint 2: Staking</h1>

<p>The first challenge after getting my environment set up is to implement staking.</p>

<p>I add the 2 variables needed and implement the stake function below</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mapping ( address =&gt; uint256 ) public balances;
uint256 public constant threshold = 1 ether;
</code></pre></div></div>

<p>Then i implement the staking function</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/// Emit when stake() is called
event Stake(address sender, uint256 value);

// Collect funds in a payable `stake()` function and track individual `balances` with a mapping:
//  ( make sure to add a `Stake(address,uint256)` event and emit it for the frontend &lt;List/&gt; display )
function stake() public payable {
   balances[msg.sender] += msg.value;

   emit Stake(msg.sender, msg.value);
}
</code></pre></div></div>

<p>Since he stake function is marked as <code class="language-plaintext highlighter-rouge">payable</code>, the function is able to recieve ether and has access to the sender‚Äôs address -<code class="language-plaintext highlighter-rouge">msg.sender</code>-  and the amount of ether sent - <code class="language-plaintext highlighter-rouge">msg.value</code>.</p>

<p>Using these variables, we can update the contract‚Äôs <code class="language-plaintext highlighter-rouge">balances</code> mapping with the total amount of ether that address has sent.</p>

<p>You‚Äôll notice I didn‚Äôt have to initialize <code class="language-plaintext highlighter-rouge">balances[msg.sender]</code> to 0. Solidity will automatically initialize variables to 0 values.</p>

<p>After updating, the function emit‚Äôs a Stake event. This is how our UI will know something has happened on the blockchain.</p>

<h1 id="checkpoint-3">
<a class="anchor" href="#checkpoint-3" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checkpoint 3</h1>

<p>The next checkout is the meat of the contract. I need to keeps track of what state the contract is in. Is it open for staking? Does the contract balance exceed the threshold? Have we passed the deadline?</p>

<p>Let‚Äôs talk about each function separately.</p>

<p>First we have execute</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Staking deadline
uint256 public deadline = block.timestamp + 30 seconds;

/// Boolean set if threshold is not reached by the deadline
bool public openForWithdraw;

// After some `deadline` allow anyone to call an `execute()` function
// It should either call `exampleExternalContract.complete{value: address(this).balance}()` to send all the value
function execute() public stakingNotCompleted {
  uint256 contractBalance = address(this).balance;
  if (contractBalance &gt;= threshold) {
    // if the `threshold` is met, send the balance to the externalContract
    exampleExternalContract.complete{value: contractBalance}();
  } else {
    // if the `threshold` was not met, allow everyone to call a `withdraw()` function
    openForWithdraw = true;
  }
}

</code></pre></div></div>

<p>Next we have withdraw</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Add a `withdraw(address payable)` function lets users withdraw their balance
function withdraw(address payable _to) public deadlinePassed(true) stakingNotCompleted {
    // check the amount staked did not reach the threshold by the deadline
    require(openForWithdraw, "Not open for withdraw");

    // get the sender balance
    uint256 userBalance = balances[msg.sender];

    // check if the sender has a balance to withdraw
    require(userBalance &gt; 0, "userBalance is 0");

    // reset the sender's balance
    balances[msg.sender] = 0;

    // transfer sender's balance to the `_to` address
    (bool sent, ) = _to.call{value: userBalance}("");

    // check transfer was successful
    require(sent, "Failed to send to address");
}
</code></pre></div></div>

<p>Finally the helper function timeLeft</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/// Add a `timeLeft()` view function that returns the time left before the deadline for the frontend
function timeLeft() public view returns (uint256) {
    if (block.timestamp &gt;= deadline) {
        return 0;
    } else {
        return deadline - block.timestamp;
    }
}
</code></pre></div></div>

<ul>
  <li>
    <p>requires</p>
  </li>
  <li>
    <p>timestamp</p>
  </li>
  <li>
    <p>address(this).balance</p>
  </li>
  <li>
    <p>calling other contracts</p>
  </li>
  <li>
    <p>sending ether to an address</p>
  </li>
  <li>
    <p>view</p>
  </li>
  <li>
    <p>returns</p>
  </li>
</ul>

<h1 id="checkpoint-4">
<a class="anchor" href="#checkpoint-4" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checkpoint 4</h1>

<p>For this checkpoint, we implement a <code class="language-plaintext highlighter-rouge">receive</code> function to automatically stake eth which has been sent to the contract address.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Add the `receive()` special function that receives eth and calls stake()
receive() external payable {
    stake();
}
</code></pre></div></div>

<p>We also create some modifiers to share logic across functions</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /// Modifier that checks whether the required deadline has passed
  modifier deadlinePassed(bool requireDeadlinePassed) {
    uint256 timeRemaining = timeLeft();
    if (requireDeadlinePassed) {
      require(timeRemaining &lt;= 0, "Deadline has not been passed yet");
    } else {
      require(timeRemaining &gt; 0, "Deadline is already passed");
    }
    _;
  }

  /// Modifier that checks whether the external contract is completed
  modifier stakingNotCompleted() {
    bool completed = exampleExternalContract.completed();
    require(!completed, "Staking period has completed");
    _;
  }
</code></pre></div></div>

<h1 id="so-what-did-we-do">
<a class="anchor" href="#so-what-did-we-do" aria-hidden="true"><span class="octicon octicon-link"></span></a>So What Did We Do?</h1>

<p>I updated the code to point at the <code class="language-plaintext highlighter-rouge">Rinkeby</code> ethereum test net and deployed the frontend to surge.</p>

<p>You can see the deployed UI here althrough the staking period is over by now.</p>

<p>Now on to Challenge 2.</p>

<p>See you then!</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="leogau/leogau.dev"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/2022/02/03/speed-run-eth-ch-1.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Exploring Deep Learning</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/leogau" target="_blank" title="leogau"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/leogau" target="_blank" title="leogau"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
