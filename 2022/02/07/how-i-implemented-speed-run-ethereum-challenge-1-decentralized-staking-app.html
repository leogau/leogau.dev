<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How I Implemented Speed Run Ethereum Challenge 1: Decentralized Staking App | Leo Gau</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="How I Implemented Speed Run Ethereum Challenge 1: Decentralized Staking App" />
<meta name="author" content="Leo Gau" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Explaining my accepted solution to Speed Run Ethereum Challenge 1" />
<meta property="og:description" content="Explaining my accepted solution to Speed Run Ethereum Challenge 1" />
<link rel="canonical" href="https://leogau.dev/2022/02/07/how-i-implemented-speed-run-ethereum-challenge-1-decentralized-staking-app.html" />
<meta property="og:url" content="https://leogau.dev/2022/02/07/how-i-implemented-speed-run-ethereum-challenge-1-decentralized-staking-app.html" />
<meta property="og:site_name" content="Leo Gau" />
<meta property="og:image" content="https://leogau.dev/images/staker.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-02-07T00:00:00-06:00" />
<script type="application/ld+json">
{"url":"https://leogau.dev/2022/02/07/how-i-implemented-speed-run-ethereum-challenge-1-decentralized-staking-app.html","@type":"BlogPosting","headline":"How I Implemented Speed Run Ethereum Challenge 1: Decentralized Staking App","dateModified":"2022-02-07T00:00:00-06:00","datePublished":"2022-02-07T00:00:00-06:00","image":"https://leogau.dev/images/staker.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://leogau.dev/2022/02/07/how-i-implemented-speed-run-ethereum-challenge-1-decentralized-staking-app.html"},"author":{"@type":"Person","name":"Leo Gau"},"description":"Explaining my accepted solution to Speed Run Ethereum Challenge 1","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://leogau.dev/feed.xml" title="Leo Gau" /><!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-40857106-3"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "UA-40857106-3", { anonymize_ip: true });
</script>


<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Leo Gau</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="https://twitter.com/leogau" target="_blank">About</a><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How I Implemented Speed Run Ethereum Challenge 1: Decentralized Staking App</h1><p class="page-description">Explaining my accepted solution to Speed Run Ethereum Challenge 1</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-02-07T00:00:00-06:00" itemprop="datePublished">
        Feb 7, 2022
      </time>‚Ä¢ 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Leo Gau</span></span>
       ‚Ä¢ <span class="read-time" title="Estimated read time">
    
    
      8 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i>
      
        <a class="category-tags-link" href="/categories/#solidity">solidity</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#ethereum">ethereum</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#what-im-building">What I‚Äôm Building</a></li>
<li class="toc-entry toc-h1"><a href="#the-code">The Code</a></li>
<li class="toc-entry toc-h1"><a href="#checkpoint-2--staking-">Checkpoint 2: ü•© Staking üíµ</a>
<ul>
<li class="toc-entry toc-h2"><a href="#extra-credit---modifiers">Extra Credit - modifiers</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#checkpoint-3--state-machine--timing-">Checkpoint 3: üî¨ State Machine / Timing ‚è±</a></li>
<li class="toc-entry toc-h1"><a href="#checkpoint-4--receive-function--ux-">Checkpoint 4: üíµ Receive Function / UX üôé</a></li>
<li class="toc-entry toc-h1"><a href="#so-what-did-we-do">So What Did We Do?</a></li>
</ul><h1 id="what-im-building">
<a class="anchor" href="#what-im-building" aria-hidden="true"><span class="octicon octicon-link"></span></a>What I‚Äôm Building</h1>

<p>In this post, I‚Äôll show you how I implemented Challenge 1 of Speed Run ETH.</p>

<p>Here‚Äôs the description from the challenge page: <a href="https://speedrunethereum.com/challenge/decentralized-staking">https://speedrunethereum.com/challenge/decentralized-staking</a></p>

<blockquote>
  <p>üè¶ Build a <code class="language-plaintext highlighter-rouge">Staker.sol</code> contract that collects <strong>ETH</strong> from numerous addresses using a payable <code class="language-plaintext highlighter-rouge">stake()</code> function and keeps track of <code class="language-plaintext highlighter-rouge">balances</code>. After some <code class="language-plaintext highlighter-rouge">deadline</code> if it has at least some <code class="language-plaintext highlighter-rouge">threshold</code> of ETH, it sends it to an <code class="language-plaintext highlighter-rouge">ExampleExternalContract</code> and triggers the <code class="language-plaintext highlighter-rouge">complete()</code> action sending the full balance. If not enough <strong>ETH</strong> is collected, allow users to <code class="language-plaintext highlighter-rouge">withdraw()</code>.</p>
</blockquote>

<h1 id="the-code">
<a class="anchor" href="#the-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Code</h1>

<p>Deployed contract address: <a href="https://rinkeby.etherscan.io/address/0x137cbEAA01865C1Ca907e4692bc1307c72e3b9d4">https://rinkeby.etherscan.io/address/0x137cbEAA01865C1Ca907e4692bc1307c72e3b9d4</a></p>

<p>Deployed UI: <a href="https://macabre-cakes.surge.sh/">https://macabre-cakes.surge.sh/</a></p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT
</span><span class="k">pragma</span> <span class="n">solidity</span> <span class="mf">0.8</span><span class="p">.</span><span class="mi">4</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"hardhat/console.sol"</span><span class="p">;</span>
<span class="k">import</span> <span class="s">"./ExampleExternalContract.sol"</span><span class="p">;</span>

<span class="k">contract</span> <span class="n">Staker</span> <span class="p">{</span>
  <span class="c1">// VARIABLES
</span>  <span class="c1">/// External contract that will hold staked funds if threshold reached
</span>  <span class="n">ExampleExternalContract</span> <span class="k">public</span> <span class="n">exampleExternalContract</span><span class="p">;</span>

  <span class="c1">/// Balances of user's staked funds
</span>  <span class="k">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="k">public</span> <span class="n">balances</span><span class="p">;</span>

  <span class="c1">/// Staking threshold
</span>  <span class="kt">uint256</span> <span class="k">public</span> <span class="k">constant</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mi">1</span> <span class="kc">ether</span><span class="p">;</span>

  <span class="c1">/// Staking deadline
</span>  <span class="kt">uint256</span> <span class="k">public</span> <span class="n">deadline</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="mi">72</span> <span class="kc">hours</span><span class="p">;</span>

  <span class="c1">/// Boolean set if threshold is not reached by the deadline
</span>  <span class="kt">bool</span> <span class="k">public</span> <span class="n">openForWithdraw</span><span class="p">;</span>

  <span class="c1">// EVENTS
</span>  <span class="c1">/// Emit when stake() is called
</span>  <span class="k">event</span> <span class="n">Stake</span><span class="p">(</span><span class="kt">address</span> <span class="n">sender</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">value</span><span class="p">);</span>

  <span class="c1">// MODIFIERS
</span>  <span class="c1">/// Modifier that checks whether the required deadline has passed
</span>  <span class="k">modifier</span> <span class="n">deadlinePassed</span><span class="p">(</span><span class="kt">bool</span> <span class="n">requireDeadlinePassed</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">timeRemaining</span> <span class="o">=</span> <span class="n">timeLeft</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">requireDeadlinePassed</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">require</span><span class="p">(</span><span class="n">timeRemaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Deadline has not been passed yet"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nb">require</span><span class="p">(</span><span class="n">timeRemaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Deadline is already passed"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">/// Modifier that checks whether the external contract is completed
</span>  <span class="k">modifier</span> <span class="n">stakingNotCompleted</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">completed</span> <span class="o">=</span> <span class="n">exampleExternalContract</span><span class="p">.</span><span class="n">completed</span><span class="p">();</span>
    <span class="nb">require</span><span class="p">(</span><span class="o">!</span><span class="n">completed</span><span class="p">,</span> <span class="s">"Staking period has completed"</span><span class="p">);</span>
    <span class="n">_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">exampleExternalContractAddress</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
      <span class="n">exampleExternalContract</span> <span class="o">=</span> <span class="n">ExampleExternalContract</span><span class="p">(</span><span class="n">exampleExternalContractAddress</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Collect funds in a payable `stake()` function and track individual `balances` with a mapping:
</span>  <span class="c1">//  ( make sure to add a `Stake(address,uint256)` event and emit it for the frontend &lt;List/&gt; display )
</span>  <span class="k">function</span> <span class="n">stake</span><span class="p">()</span> <span class="k">public</span> <span class="k">payable</span> <span class="n">deadlinePassed</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="n">stakingNotCompleted</span> <span class="p">{</span>
    <span class="c1">// update the sender's balance
</span>    <span class="n">balances</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

    <span class="c1">// emit Stake event to notify the UI
</span>    <span class="k">emit</span> <span class="n">Stake</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
  <span class="p">}</span>


  <span class="c1">// After some `deadline` allow anyone to call an `execute()` function
</span>  <span class="c1">//  It should either call `exampleExternalContract.complete{value: address(this).balance}()` to send all the value
</span>  <span class="k">function</span> <span class="n">execute</span><span class="p">()</span> <span class="k">public</span> <span class="n">stakingNotCompleted</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">contractBalance</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">contractBalance</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// if the `threshold` is met, send the balance to the externalContract
</span>      <span class="n">exampleExternalContract</span><span class="p">.</span><span class="n">complete</span><span class="p">{</span><span class="n">value</span><span class="o">:</span> <span class="n">contractBalance</span><span class="p">}();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// if the `threshold` was not met, allow everyone to call a `withdraw()` function
</span>      <span class="n">openForWithdraw</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>



  <span class="c1">// Add a `withdraw(address payable)` function lets users withdraw their balance
</span>  <span class="k">function</span> <span class="n">withdraw</span><span class="p">(</span><span class="kt">address</span> <span class="k">payable</span> <span class="n">_to</span><span class="p">)</span> <span class="k">public</span> <span class="n">deadlinePassed</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="n">stakingNotCompleted</span> <span class="p">{</span>
      <span class="c1">// check the amount staked did not reach the threshold by the deadline
</span>      <span class="nb">require</span><span class="p">(</span><span class="n">openForWithdraw</span><span class="p">,</span> <span class="s">"Not open for withdraw"</span><span class="p">);</span>

      <span class="c1">// get the sender balance
</span>      <span class="kt">uint256</span> <span class="n">userBalance</span> <span class="o">=</span> <span class="n">balances</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">];</span>

      <span class="c1">// check if the sender has a balance to withdraw
</span>      <span class="nb">require</span><span class="p">(</span><span class="n">userBalance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"userBalance is 0"</span><span class="p">);</span>

      <span class="c1">// reset the sender's balance
</span>      <span class="n">balances</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="c1">// transfer sender's balance to the `_to` address
</span>      <span class="p">(</span><span class="kt">bool</span> <span class="n">sent</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">_to</span><span class="p">.</span><span class="nb">call</span><span class="p">{</span><span class="n">value</span><span class="o">:</span> <span class="n">userBalance</span><span class="p">}(</span><span class="s">""</span><span class="p">);</span>

      <span class="c1">// check transfer was successful
</span>      <span class="nb">require</span><span class="p">(</span><span class="n">sent</span><span class="p">,</span> <span class="s">"Failed to send to address"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// Add a `timeLeft()` view function that returns the time left before the deadline for the frontend
</span>  <span class="k">function</span> <span class="n">timeLeft</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">deadline</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">block</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>


  <span class="c1">// Add the `receive()` special function that receives eth and calls stake()
</span>  <span class="k">receive</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
      <span class="n">stake</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="checkpoint-2--staking-">
<a class="anchor" href="#checkpoint-2--staking-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checkpoint 2: ü•© Staking üíµ</h1>

<p>The first challenge after getting my environment set up is to implement staking.</p>

<p>I add the 2 variables needed</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">mapping</span> <span class="p">(</span> <span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span> <span class="p">)</span> <span class="k">public</span> <span class="n">balances</span><span class="p">;</span>
<span class="kt">uint256</span> <span class="k">public</span> <span class="k">constant</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mi">1</span> <span class="kc">ether</span><span class="p">;</span>
</code></pre></div></div>

<p>Then I implement the staking function</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// Emit when stake() is called
</span><span class="k">event</span> <span class="n">Stake</span><span class="p">(</span><span class="kt">address</span> <span class="n">sender</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">value</span><span class="p">);</span>

<span class="c1">/// Modifier that checks whether the external contract is completed
</span><span class="k">modifier</span> <span class="n">stakingNotCompleted</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">completed</span> <span class="o">=</span> <span class="n">exampleExternalContract</span><span class="p">.</span><span class="n">completed</span><span class="p">();</span>
  <span class="nb">require</span><span class="p">(</span><span class="o">!</span><span class="n">completed</span><span class="p">,</span> <span class="s">"Staking period has completed"</span><span class="p">);</span>
  <span class="n">_</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/// Modifier that checks whether the required deadline has passed
</span><span class="k">modifier</span> <span class="n">deadlinePassed</span><span class="p">(</span><span class="kt">bool</span> <span class="n">requireDeadlinePassed</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint256</span> <span class="n">timeRemaining</span> <span class="o">=</span> <span class="n">timeLeft</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">requireDeadlinePassed</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">require</span><span class="p">(</span><span class="n">timeRemaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Deadline has not been passed yet"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">require</span><span class="p">(</span><span class="n">timeRemaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Deadline is already passed"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">_</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Collect funds in a payable `stake()` function and track individual `balances` with a mapping:
//  ( make sure to add a `Stake(address,uint256)` event and emit it for the frontend &lt;List/&gt; display )
</span><span class="k">function</span> <span class="n">stake</span><span class="p">()</span> <span class="k">public</span> <span class="k">payable</span> <span class="n">deadlinePassed</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="n">stakingNotCompleted</span> <span class="p">{</span>
  <span class="c1">// update the sender's balance
</span>  <span class="n">balances</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

  <span class="c1">// emit Stake event to notify the UI
</span>  <span class="k">emit</span> <span class="n">Stake</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Since the stake function is marked as <code class="language-plaintext highlighter-rouge">payable</code>, the function is able to recieve ether and has access to the sender‚Äôs address through <code class="language-plaintext highlighter-rouge">msg.sender</code> and the amount of ether sent through <code class="language-plaintext highlighter-rouge">msg.value</code>.</p>

<p>Using these variables, I can update the contract‚Äôs <code class="language-plaintext highlighter-rouge">balances</code> mapping with the total amount of ether that address has sent.</p>

<p>You‚Äôll notice I didn‚Äôt have to initialize <code class="language-plaintext highlighter-rouge">balances[msg.sender]</code> to 0. Solidity will automatically initialize variables to 0 values.</p>

<p>After updating, the function emit‚Äôs a <code class="language-plaintext highlighter-rouge">Stake</code> event. This is how I alert the UI that something has happened on the blockchain.</p>

<h2 id="extra-credit---modifiers">
<a class="anchor" href="#extra-credit---modifiers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Extra Credit - modifiers</h2>

<p>I‚Äôve included 2 modifiers here that are useful for later challenges. I separated these specific validations because they‚Äôre needed in multiple functions as we‚Äôll see later.</p>

<p>The first is <code class="language-plaintext highlighter-rouge">deadlinePassed</code>. If I pass <code class="language-plaintext highlighter-rouge">false</code> to this modifer, it means the function will only execute if the deadline has NOT passed. We‚Äôll see a different usage of this modifier in the <code class="language-plaintext highlighter-rouge">withdraw</code> function.</p>

<p>There is also the <code class="language-plaintext highlighter-rouge">stakingNotCompleted</code> modifier. If the balance has already been sent to the external contract, staking is completed and <code class="language-plaintext highlighter-rouge">execute</code> will fail and revert.</p>

<h1 id="checkpoint-3--state-machine--timing-">
<a class="anchor" href="#checkpoint-3--state-machine--timing-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checkpoint 3: üî¨ State Machine / Timing ‚è±</h1>

<p>The next checkout is the core logic of the contract. I need to keeps track of what state the contract is in. Is it open for staking? Does the contract balance exceed the threshold? Have we passed the deadline?</p>

<p>I‚Äôll walk through each function separately.</p>

<p>First, there‚Äôs <code class="language-plaintext highlighter-rouge">execute</code></p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Staking deadline
</span><span class="kt">uint256</span> <span class="k">public</span> <span class="n">deadline</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="mi">30</span> <span class="kc">seconds</span><span class="p">;</span>

<span class="c1">/// Boolean set if threshold is not reached by the deadline
</span><span class="kt">bool</span> <span class="k">public</span> <span class="n">openForWithdraw</span><span class="p">;</span>

<span class="c1">// After some `deadline` allow anyone to call an `execute()` function
// It should either call `exampleExternalContract.complete{value: address(this).balance}()` to send all the value
</span><span class="k">function</span> <span class="n">execute</span><span class="p">()</span> <span class="k">public</span> <span class="n">stakingNotCompleted</span> <span class="p">{</span>
  <span class="kt">uint256</span> <span class="n">contractBalance</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">contractBalance</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// if the `threshold` is met, send the balance to the externalContract
</span>    <span class="n">exampleExternalContract</span><span class="p">.</span><span class="n">complete</span><span class="p">{</span><span class="n">value</span><span class="o">:</span> <span class="n">contractBalance</span><span class="p">}();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// if the `threshold` was not met, allow everyone to call a `withdraw()` function
</span>    <span class="n">openForWithdraw</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>This first checks if the deadline has passed or not through the <code class="language-plaintext highlighter-rouge">stakingNotCompleted</code> modifier.</p>

<p>If the staking is not completed, we next check the contract balance and see if it‚Äôs exceeded the threshold. If so, we complete the staking period by sending the balance to the external contract.</p>

<p>If not, I set the <code class="language-plaintext highlighter-rouge">openForWithdraw</code> boolean to <code class="language-plaintext highlighter-rouge">true</code> and allow everyone to withdraw their money back.</p>

<p>Next, let‚Äôs look at the <code class="language-plaintext highlighter-rouge">withdraw</code> function</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Add a `withdraw(address payable)` function lets users withdraw their balance
</span><span class="k">function</span> <span class="n">withdraw</span><span class="p">(</span><span class="kt">address</span> <span class="k">payable</span> <span class="n">_to</span><span class="p">)</span> <span class="k">public</span> <span class="n">deadlinePassed</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="n">stakingNotCompleted</span> <span class="p">{</span>
    <span class="c1">// check the amount staked did not reach the threshold by the deadline
</span>    <span class="nb">require</span><span class="p">(</span><span class="n">openForWithdraw</span><span class="p">,</span> <span class="s">"Not open for withdraw"</span><span class="p">);</span>

    <span class="c1">// get the sender balance
</span>    <span class="kt">uint256</span> <span class="n">userBalance</span> <span class="o">=</span> <span class="n">balances</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">];</span>

    <span class="c1">// check if the sender has a balance to withdraw
</span>    <span class="nb">require</span><span class="p">(</span><span class="n">userBalance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"userBalance is 0"</span><span class="p">);</span>

    <span class="c1">// reset the sender's balance
</span>    <span class="n">balances</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// transfer sender's balance to the `_to` address
</span>    <span class="p">(</span><span class="kt">bool</span> <span class="n">sent</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">_to</span><span class="p">.</span><span class="nb">call</span><span class="p">{</span><span class="n">value</span><span class="o">:</span> <span class="n">userBalance</span><span class="p">}(</span><span class="s">""</span><span class="p">);</span>

    <span class="c1">// check transfer was successful
</span>    <span class="nb">require</span><span class="p">(</span><span class="n">sent</span><span class="p">,</span> <span class="s">"Failed to send to address"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Once the modifiers are passed, I check that the contract is open for withdraw and that the user has ether to send back. Before actually sending the ether, notice that I set the sender‚Äôs balance to 0 in the contract‚Äôs <code class="language-plaintext highlighter-rouge">balances</code> mapping.</p>

<p>I always want to make all state changes before calling other contracts or sending ether. This prevents something known as a <a href="https://solidity-by-example.org/hacks/re-entrancy/">Re-Entrancy attack</a>. If we were to send the balance before setting the sender‚Äôs balance to 0, it‚Äôs possible for the sender to call <code class="language-plaintext highlighter-rouge">withdraw</code> multiple times before the <code class="language-plaintext highlighter-rouge">_to.call</code> function completes. The contract will think the sender still has an ether balance and will keep sending extra ether until the first call completes.</p>

<p>Finally, after all checks have passed, I send the ether and check that the transfer was successful.</p>

<p>The last function to mention is the helper function <code class="language-plaintext highlighter-rouge">timeLeft</code></p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// Add a `timeLeft()` view function that returns the time left before the deadline for the frontend
</span><span class="k">function</span> <span class="n">timeLeft</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">deadline</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">block</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is used in <code class="language-plaintext highlighter-rouge">deadlinePassed</code> to see how much time is left in the staking period.</p>

<h1 id="checkpoint-4--receive-function--ux-">
<a class="anchor" href="#checkpoint-4--receive-function--ux-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checkpoint 4: üíµ Receive Function / UX üôé</h1>

<p>For this checkpoint, we implement a <code class="language-plaintext highlighter-rouge">receive</code> function to automatically stake eth which has been sent to the contract address.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Add the `receive()` special function that receives eth and calls stake()
receive() external payable {
    stake();
}
</code></pre></div></div>

<h1 id="so-what-did-we-do">
<a class="anchor" href="#so-what-did-we-do" aria-hidden="true"><span class="octicon octicon-link"></span></a>So What Did We Do?</h1>

<p>I updated the code to point at the <code class="language-plaintext highlighter-rouge">Rinkeby</code> ethereum test net and deployed the frontend to <a href="https://macabre-cakes.surge.sh/">https://macabre-cakes.surge.sh/</a></p>

<p>You can try it out for yourself although the staking period is over by now.</p>

<p>Now on to <a href="https://speedrunethereum.com/challenge/token-vendor">Challenge 2: Token Vendor</a>.</p>

<p>See you then!</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="leogau/leogau.dev"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/2022/02/07/how-i-implemented-speed-run-ethereum-challenge-1-decentralized-staking-app.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Exploring Deep Learning</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/leogau" target="_blank" title="leogau"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/leogau" target="_blank" title="leogau"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
